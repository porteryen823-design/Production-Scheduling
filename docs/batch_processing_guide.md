# 批次加工（Batch Processing）功能說明

## 功能概述

本功能實現了第五作業站（STEP5）的批次加工邏輯，允許多個 Lots 同時在同一台機器上進行加工，以提高生產效率。

## 核心規則

1. **批次大小限制**：最多可以同時處理 N 批（預設 N=2）
2. **等待時間上限**：10 分鐘（可配置）
3. **彈性開始**：如果 10 分鐘內湊不到 N 批，已到的批次可以先開始加工
4. **同步加工**：同批加工的 Lots 同時開始、同時結束

## 環境變數配置

在 `.env` 檔案中可以配置以下參數：

```bash
# 批次加工設定
BATCH_PROCESSING_MAX_SIZE=2           # 每批最多處理的 Lot 數量
BATCH_PROCESSING_MAX_WAIT_MINUTES=10  # 等待時間上限（分鐘）
```

## 實現邏輯

### 1. 批次分配機制

- 為每個需要在 STEP5 加工的 Lot 創建批次分配變數
- 計算可能需要的批次數量：`num_possible_batches = ⌈總 Lot 數 / MAX_BATCH_SIZE⌉`
- 每個 Lot 被分配到一個特定的批次編號（0 到 num_possible_batches-1）

### 2. 時間同步約束

**約束 1：同批次 Lots 的時間同步**
- 如果 Lot 被分配到批次 k，則該 Lot 的開始時間 = 批次 k 的開始時間
- 如果 Lot 被分配到批次 k，則該 Lot 的結束時間 = 批次 k 的結束時間
- 這確保了同一批次中的所有 Lots 同時開始、同時結束

### 3. 批次大小約束

**約束 2：批次容量限制**
- 每個批次最多包含 `MAX_BATCH_SIZE` 個 Lots
- 使用布林變數統計每個批次中的 Lot 數量
- 如果批次為空，則標記為 inactive

### 4. 等待時間約束

**約束 3：等待時間上限**
- 計算每個 Lot 到達 STEP5 的時間（即前一個作業的結束時間）
- 批次開始時間必須 >= 該批次中所有 Lots 的到達時間
- 批次開始時間 - Lot 到達時間 <= `MAX_WAIT_TIME`
- 這確保了不會有 Lot 等待過長時間

### 5. 批次順序約束

**約束 4：批次順序**
- 批次 k 必須在批次 k+1 之前完成
- 這避免了批次之間的時間衝突

### 6. 加工時間約束

**約束 5：批次持續時間**
- 批次的持續時間 = STEP5 的標準加工時間
- 批次結束時間 = 批次開始時間 + 加工時間

## 運作範例

假設有 5 個 Lots（L1, L2, L3, L4, L5）需要在 STEP5 加工：
- MAX_BATCH_SIZE = 2
- MAX_WAIT_TIME = 10 分鐘
- STEP5 加工時間 = 30 分鐘

### 場景 1：理想情況

```
時間軸：
0min    10min   20min   30min   40min   50min   60min   70min
|-------|-------|-------|-------|-------|-------|-------|
L1 到達 ↓
L2 到達   ↓
        [批次1: L1+L2 同時加工 30min]
                                L3 到達 ↓
                                L4 到達   ↓
                                [批次2: L3+L4 同時加工 30min]
                                                        L5 到達 ↓
                                                        [批次3: L5 單獨加工 30min]
```

### 場景 2：等待時間限制

```
時間軸：
0min    10min   20min   30min   40min   50min   60min
|-------|-------|-------|-------|-------|-------|
L1 到達 ↓
        [等待 L2...]
        10min 到達上限，L1 先開始
        [批次1: L1 單獨加工 30min]
                L2 到達 ↓
                                [批次2: L2 單獨加工 30min]
```

## 適用場景

此功能特別適合以下生產場景：

1. **烘烤/加熱製程**：多個產品可以同時放入烤箱
2. **清洗/塗裝製程**：多個零件可以同時進行表面處理
3. **測試/檢驗製程**：多個產品可以同時進行測試
4. **化學處理製程**：多個批次可以同時進行化學反應

## 擴展性

如果需要為其他作業站啟用批次加工：

1. 修改 `BATCH_STEP` 變數（例如改為 "STEP3"）
2. 可以為不同作業站設定不同的批次大小和等待時間
3. 可以同時為多個作業站啟用批次加工（需要複製並調整約束邏輯）

## 注意事項

1. **機台選擇**：批次加工不影響機台選擇邏輯，同一批次的 Lots 仍然可以選擇不同的機台（如果有多台可用）
2. **WIP/Frozen Lots**：只有狀態為 "Normal" 的 Lots 才會參與批次加工
3. **求解時間**：批次加工會增加約束數量，可能會增加求解時間，建議適當調整 `SOLVER_MAX_TIME_IN_SECONDS`

## 驗證方法

執行排程後，檢查 `plan_result/LotStepResult.json`：
- 找到 STEP5 的所有記錄
- 確認同一批次的 Lots 具有相同的 Start 和 End 時間
- 確認每批最多包含 MAX_BATCH_SIZE 個 Lots
- 確認等待時間不超過 MAX_WAIT_TIME
