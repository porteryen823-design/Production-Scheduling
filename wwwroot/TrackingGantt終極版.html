<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專案甘特圖 - 規劃與實際進度對比</title>
    
    <!-- dhtmlxGantt v7.1.13 CSS -->
    <link rel="stylesheet" href="css/dhtmlxgantt.css" />
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            background-color: #f5f5f5;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            margin: 0 0 15px 0;
            font-size: 24px;
            color: #333;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .legend-box {
            width: 30px;
            height: 15px;
            border-radius: 4px;
        }
        
        #gantt_here {
            flex: 1;
            width: 100%;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* 核心修正：處理 Standard 版本不支援 addTaskLayer 的問題 */
        .gantt_task_line {
            background-color: transparent !important;
            border: none !important;
            overflow: visible !important;
        }
        
        .gantt_task_content {
            overflow: visible !important;
        }
        
        /* 規劃時程樣式 (藍色) - 放在上方 */
        .baseline_bar {
            position: absolute;
            border-radius: 4px;
            height: 12px;
            background-color: #4A90E2;
            top: -18px; /* 向上偏移 */
            z-index: 1;
        }
        
        /* 實際進度樣式 (綠色) - 放在下方 */
        .actual_bar {
            position: absolute;
            border-radius: 4px;
            height: 12px;
            background-color: #50C878;
            top: 2px; /* 向下偏移 */
            z-index: 1;
        }
        
        /* 延遲樣式 (紅色) */
        .delayed_bar {
            position: absolute;
            border-radius: 4px;
            height: 12px;
            background-color: #E74C3C;
            top: 2px;
            z-index: 1;
        }

        /* 增加行高以容納上下兩條線 */
        .gantt_task_row {
            height: 60px !important;
        }
        
        /* 調整任務條在行內的位置 */
        .gantt_bars_area .gantt_task_line {
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>專案甘特圖 - 規劃與實際進度對比(終極版)</h1>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-box" style="background: #4A90E2;"></div>
                    <span>規劃時程</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: #50C878;"></div>
                    <span>實際進度</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background: #E74C3C;"></div>
                    <span>延遲</span>
                </div>
            </div>
        </div>
        <div id="gantt_here"></div>
    </div>

    <!-- dhtmlxGantt v7.1.13 JS -->
    <script src="js/dhtmlxgantt.js"></script>
    <script type="text/javascript">
        // 配置甘特圖
        gantt.config.date_format = "%Y-%m-%d";
        gantt.config.row_height = 60;
        gantt.config.task_height = 12;
        
        // 時間軸配置
        gantt.config.scales = [
            {unit: "month", step: 1, format: "%n月"}
        ];
        
        // 配置列
        gantt.config.columns = [
            {name: "text", label: "任務名稱", width: 200, tree: true}
        ];

        // 使用 task_text 模板來渲染兩條線，這在 Standard 版本也能運作
        gantt.templates.task_text = function(start, end, task) {
            if (!task.planned_start || !task.planned_end) return "";

            // 計算相對於當前任務條起始點的位置
            var task_start_pos = gantt.posFromDate(start);
            var p_start_pos = gantt.posFromDate(task.planned_start);
            var p_end_pos = gantt.posFromDate(task.planned_end);
            var a_start_pos = gantt.posFromDate(task.start_date);
            var a_end_pos = gantt.posFromDate(task.end_date);

            var p_left = p_start_pos - task_start_pos;
            var p_width = p_end_pos - p_start_pos;
            var a_left = a_start_pos - task_start_pos;
            var a_width = a_end_pos - a_start_pos;

            var is_delayed = task.end_date > task.planned_end;
            var actual_class = is_delayed ? 'delayed_bar' : 'actual_bar';

            var html = "";
            // 規劃條
            html += "<div class='baseline_bar' style='left:" + p_left + "px; width:" + p_width + "px;'></div>";
            // 實際條
            html += "<div class='" + actual_class + "' style='left:" + a_left + "px; width:" + a_width + "px;'></div>";
            
            return html;
        };

        // 初始化
        gantt.init("gantt_here");
        console.log("甘特圖已初始化");

        // 載入範例資料
        gantt.parse({
            data: [
                {
                    id: 1, text: "需求分析", 
                    planned_start: new Date(2026, 0, 1), planned_end: new Date(2026, 1, 15),
                    start_date: "2026-01-01", end_date: "2026-02-25", progress: 0.0
                },
                {
                    id: 2, text: "系統設計", 
                    planned_start: new Date(2026, 2, 1), planned_end: new Date(2026, 4, 1),
                    start_date: "2026-03-10", end_date: "2026-05-01", progress: 0
                },
                {
                    id: 3, text: "前端開發", 
                    planned_start: new Date(2026, 4, 15), planned_end: new Date(2026, 7, 1),
                    start_date: "2026-04-15", end_date: "2026-08-15", progress: 0
                },
                {
                    id: 4, text: "後端開發", 
                    planned_start: new Date(2026, 4, 15), planned_end: new Date(2026, 7, 1),
                    start_date: "2026-04-15", end_date: "2026-07-01", progress: 0
                },
                {
                    id: 5, text: "整合測試", 
                    planned_start: new Date(2026, 7, 15), planned_end: new Date(2026, 9, 1),
                    start_date: "2026-08-10", end_date: "2026-09-20", progress: 0                    
                },
                {
                    id: 6, text: "上線部署", 
                    planned_start: new Date(2026, 9, 15), planned_end: new Date(2026, 10, 15),
                    start_date: "2026-09-15", end_date: "2026-10-15", progress: 0
                }
            ]
        });
        console.log("資料已載入:", gantt.getTaskByTime().length, "個任務");
    </script>
</body>
</html>
