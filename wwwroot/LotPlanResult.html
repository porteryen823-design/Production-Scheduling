<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Lot Plan Result 表格顯示</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />

    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #0f172a;
            --header-bg: #f8fafc;
            --border-color: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-hover: rgba(0, 0, 0, 0.1);
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --success-hover: #059669;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --secondary: #64748b;
            --secondary-hover: #475569;
            --muted-text: #64748b;
            --card-bg: rgba(255, 255, 255, 0.8);
            --glass-bg: rgba(255, 255, 255, 0.1);
        }

        [data-theme="gray"] {
            --bg-color: #e5e7eb;      /* Gray 200 - 明顯的灰色背景 */
            --text-color: #1f2937;    /* Gray 800 */
            --header-bg: #d1d5db;     /* Gray 300 - 較深的標題背景 */
            --border-color: #9ca3af;  /* Gray 400 - 加深邊框 */
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(0, 0, 0, 0.2);
            --muted-text: #4b5563;
            --card-bg: rgba(243, 244, 246, 0.9); /* Gray 100 with opacity */
            --glass-bg: rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-color: #f8fafc;
            --header-bg: #1e293b;
            --border-color: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.4);
            --primary: #60a5fa;
            --primary-hover: #3b82f6;
            --success: #34d399;
            --success-hover: #10b981;
            --warning: #fbbf24;
            --warning-hover: #f59e0b;
            --danger: #f87171;
            --danger-hover: #ef4444;
            --secondary: #94a3b8;
            --secondary-hover: #64748b;
            --muted-text: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.8);
            --glass-bg: rgba(255, 255, 255, 0.05);
        }

        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            background: linear-gradient(135deg, var(--bg-color) 0%, var(--header-bg) 100%);
            color: var(--text-color);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container-fluid {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px var(--shadow);
            border-radius: 16px;
            margin: 20px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .container-fluid:hover {
            box-shadow: 0 8px 25px var(--shadow-hover);
        }

        .table-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--shadow);
            padding: 0;
            margin: 10px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .btn-group .btn {
            transition: all 0.2s ease;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            padding: 8px 16px;
            margin: 0 2px;
        }

        .btn-group .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-outline-secondary {
            background: var(--card-bg);
            color: var(--secondary);
            border: 1px solid var(--border-color);
        }

        .btn-outline-secondary:hover {
            background: var(--secondary);
            color: white;
        }

        .btn-outline-secondary {
            background: var(--card-bg);
            color: var(--secondary);
            border: 1px solid var(--border-color) !important;
        }

        .btn-outline-secondary:hover:not(:disabled) {
            background: var(--secondary) !important;
            color: white !important;
        }
        
        .btn-outline-secondary.active {
            background: var(--secondary) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12) !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-hover) 0%, var(--primary) 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-outline-success {
            background: var(--card-bg);
            color: var(--success);
            border: 1px solid var(--border-color);
        }

        .btn-outline-success:hover {
            background: var(--success);
            color: white;
        }

        h2 {
            margin: 0;
            color: var(--text-color);
            font-weight: 700;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* 統計資訊樣式優化 */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 25px var(--shadow-hover);
        }

        .card-header {
            background: linear-gradient(135deg, var(--header-bg) 0%, var(--card-bg) 100%);
            border-bottom: 2px solid var(--border-color);
            border-radius: 12px 12px 0 0 !important;
            padding: 16px 20px;
        }

        .card-title {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-col {
            border-right: 1px solid var(--border-color);
            padding: 16px 20px;
            transition: background-color 0.2s ease;
        }

        .stat-col:last-child {
            border-right: none;
        }

        .stat-col:hover {
            background: var(--glass-bg);
        }

        .stat-cell {
            border: none;
            padding: 12px 16px;
            vertical-align: top;
            transition: background-color 0.2s ease;
        }

        .stat-cell:hover {
            background: var(--glass-bg);
        }

        .stat-cell:not(:last-child) {
            border-right: 1px solid var(--border-color);
        }

        .stat-cell .stat-label {
            display: inline;
            margin-right: 8px;
            font-weight: 600;
        }

        .stat-cell .stat-value {
            display: inline;
        }

        .stat-label {
            color: var(--muted-text);
            font-weight: 600;
            font-size: 0.8rem;
            display: block;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            color: var(--text-color);
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .stat-value.small {
            font-size: 0.8rem;
            color: var(--muted-text);
        }

        /* 表格美化 */
        .table {
            background: transparent;
            color: var(--text-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .table thead th {
            background: linear-gradient(135deg, var(--header-bg) 0%, var(--card-bg) 100%);
            border: none;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-color);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 16px 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody td {
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 12px;
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: var(--glass-bg);
            transform: scale(1.01);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* 狀態徽章美化 */
        .badge {
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .bg-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-hover) 100%) !important;
        }

        .bg-info {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%) !important;
        }

        .bg-warning {
            background: linear-gradient(135deg, var(--warning) 0%, var(--warning-hover) 100%) !important;
        }

        .bg-danger {
            background: linear-gradient(135deg, var(--danger) 0%, var(--danger-hover) 100%) !important;
        }

        /* 過濾器樣式 */
        .form-select {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            padding: 8px 12px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .form-select option {
            background: var(--card-bg);
            color: var(--text-color);
        }

        /* 載入動畫 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--card-bg);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container-fluid {
                margin: 10px;
                padding: 16px;
            }

            .table-container {
                margin: 10px;
                padding: 16px;
            }

            .stat-col {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 12px 16px;
            }

            .stat-col:last-child {
                border-bottom: none;
            }

            .stat-cell {
                padding: 8px 12px;
                font-size: 0.875rem;
            }

            .stat-cell .stat-label {
                font-size: 0.75rem;
                display: block;
                margin-right: 0;
                margin-bottom: 4px;
            }

            .stat-cell .stat-value {
                font-size: 0.8rem;
                display: block;
            }

            .stat-cell[colspan="4"] .stat-label {
                display: inline;
                margin-right: 8px;
                margin-bottom: 0;
            }

            .stat-cell[colspan="4"] .stat-value {
                display: inline;
            }

            h2 {
                font-size: 1.25rem;
            }

            .table thead th,
            .table tbody td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
        }

        /* 控制面板樣式 */
        .control-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .control-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.875rem;
            white-space: nowrap;
        }

        /* 狀態指示器 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .status-info {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .status-loading {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        /* 滾動條樣式 */
        .table-responsive::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: var(--glass-bg);
            border-radius: 4px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: var(--muted-text);
        }

        /* DataTables 自定義樣式 */
        .dataTables_wrapper {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
        }

        .dataTables_filter {
            margin-bottom: 16px;
        }

        .dataTables_filter label {
            color: var(--text-color);
            font-weight: 600;
        }

        .dataTables_filter input {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            padding: 8px 12px;
            transition: all 0.2s ease;
        }

        .dataTables_filter input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .dataTables_length {
            margin-bottom: 16px;
        }

        .dataTables_length label {
            color: var(--text-color);
            font-weight: 600;
        }

        .dataTables_length select {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            padding: 4px 8px;
            transition: all 0.2s ease;
        }

        .dataTables_length select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        .dataTables_info {
            color: var(--muted-text);
            font-size: 0.875rem;
            margin-top: 16px;
        }

        .dataTables_paginate {
            margin-top: 16px;
        }

        .paginate_button {
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 12px;
            margin: 0 2px;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .paginate_button:hover {
            background: var(--glass-bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        .paginate_button.current {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .paginate_button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 排序箭頭樣式 */
        .sorting {
            background-image: none !important;
        }

        .sorting_asc::after {
            content: ' ▲';
            color: var(--primary);
            font-weight: bold;
        }

        .sorting_desc::after {
            content: ' ▼';
            color: var(--primary);
            font-weight: bold;
        }

        .sorting::after {
            content: ' ⇅';
            color: var(--muted-text);
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- 頁面標題 -->
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h2><i class="fa-solid fa-table"></i> Lot Plan Result</h2>
            <div class="status-indicator status-success">
                <i class="fa-solid fa-circle"></i>
                系統正常
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="control-row">
                <div class="control-group">
                    <a href="index.html" class="btn btn-outline-secondary btn-sm" title="返回主頁"><i class="fa-solid fa-house"></i></a>
                    <span class="control-label"><i class="fa-solid fa-palette"></i> 主題</span>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm" id="themeLightBtn" onclick="setTheme('light')" title="亮色主題">
                            <i class="fa-solid fa-sun"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="themeGrayBtn" onclick="setTheme('gray')" title="灰色主題">
                            <i class="fa-solid fa-adjust"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="themeDarkBtn" onclick="setTheme('dark')" title="暗色主題">
                            <i class="fa-solid fa-moon"></i>
                        </button>
                    </div>
                </div>

                <div class="control-group">
                    <button class="btn btn-primary btn-sm" onclick="loadData()" title="從伺服器重新載入資料">
                        <i class="fa-solid fa-sync"></i> 重新載入
                    </button>
                </div>

                <div class="control-group">
                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
                    <button class="btn btn-outline-success btn-sm" onclick="document.getElementById('jsonFileInput').click()" title="從本地檔案讀取資料">
                        <i class="fa-solid fa-upload"></i> 讀取 JSON
                    </button>
                </div>

                <div class="control-group">
                    <span class="control-label"><i class="fa-solid fa-info-circle"></i> 狀態</span>
                    <div id="dataStatus" class="status-indicator status-loading">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                        載入中...
                    </div>
                </div>
            </div>
        </div>

        <!-- 統計資訊 -->
        <div class="row mb-4" id="statisticsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fa-solid fa-chart-bar"></i> 排程統計資訊</h5>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-borderless mb-0">
                            <tbody>
                                <tr>
                                    <td class="stat-cell" colspan="2">
                                        <span class="stat-label">優化類型:</span> <span class="stat-value" id="optType"></span>
                                    </td>
                                    <td class="stat-cell" colspan="2">
                                        <span class="stat-label">計算批數:</span> <span class="stat-value" id="batchCount"></span>
                                    </td>
                                    <td class="stat-cell" colspan="2">
                                        <span class="stat-label">優化目標:</span> <span class="stat-value" id="optGoal"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="stat-cell" colspan="2">
                                        <span class="stat-label">計算總時間:</span> <span class="stat-value" id="calcDuration"></span>
                                    </td>
                                    <td class="stat-cell" colspan="2">
                                        <span class="stat-label">最早投入時間:</span> <span class="stat-value small" id="earliestInput"></span>
                                    </td>
                                    <td class="stat-cell" colspan="2">
                                        <span class="stat-label">最後產出時間:</span> <span class="stat-value small" id="latestOutput"></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="stat-cell" colspan="2">
                                        <span class="stat-label">總排程時間:</span> <span class="stat-value" id="totalDuration"></span>
                                    </td>
                                    <td class="stat-cell" colspan="2">
                                        <span class="stat-label">計算起訖時間:</span> <span class="stat-value small" id="calcTimeRange"></span>
                                    </td>
                                    <td class="stat-cell" colspan="4">
                                        <span class="stat-label">延遲統計:</span>
                                        <div class="d-flex flex-wrap gap-1 mt-1">
                                            <span class="badge bg-success">提早: <span id="earlyCount"></span></span>
                                            <span class="badge bg-info">準時: <span id="onTimeCount"></span></span>
                                            <span class="badge bg-warning">輕微延遲: <span id="minorDelayCount"></span></span>
                                            <span class="badge bg-danger">嚴重延遲: <span id="majorDelayCount"></span></span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 過濾器 -->
        <div class="control-panel">
            <div class="control-row">
                <div class="control-group">
                    <label for="lotFilter" class="control-label">
                        <i class="fa-solid fa-hashtag"></i> 批號過濾
                    </label>
                    <select id="lotFilter" class="form-select" style="width: 180px;" onchange="applyFilters()">
                        <option value="ALL">全部批號</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="productFilter" class="control-label">
                        <i class="fa-solid fa-box"></i> 產品過濾
                    </label>
                    <select id="productFilter" class="form-select" style="width: 180px;" onchange="applyFilters()">
                        <option value="ALL">全部產品</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- 表格容器 -->
    <div class="table-container">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="resultTable">
                <thead>
                    <tr>
                        <th><i class="fa-solid fa-hashtag"></i> Lot</th>
                        <th><i class="fa-solid fa-box"></i> Product</th>
                        <th><i class="fa-solid fa-star"></i> Priority</th>
                        <th><i class="fa-solid fa-calendar-times"></i> DueDate</th>
                        <th><i class="fa-solid fa-calendar-check"></i> PlanFinishDate</th>
                        <th><i class="fa-solid fa-calendar-alt"></i> ActualFinishDate</th>
                        <th><i class="fa-solid fa-clock"></i> Delay Time</th>
                        <th><i class="fa-solid fa-info-circle"></i> Status</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- 資料將動態插入這裡 -->
                </tbody>
            </table>
        </div>

        <!-- 載入遮罩 -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
        </div>
    </div>

    <script src="js/theme-manager.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let allData = [];
        let statistics = null;
        let table;

        // 設定主題
        function setTheme(theme) {
            if (window.applyTheme) {
                window.applyTheme(theme);
            } else {
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('aps_system_theme', theme);
            }
        }


        // 更新狀態指示器
        function updateStatus(status, message, type = 'info') {
            const statusEl = document.getElementById('dataStatus');
            statusEl.className = `status-indicator status-${type}`;
            statusEl.innerHTML = `<i class="fa-solid fa-${status}"></i> ${message}`;
        }

        // 顯示/隱藏載入遮罩
        function showLoading(show = true) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        // 解析延遲時間並計算總天數
        function parseDelayTime(delayStr) {
            if (!delayStr || delayStr === "0:00") return 0;

            // 處理負數格式，如 "-1:05" 或 "-0:08"
            const isNegative = delayStr.startsWith('-');
            const cleanStr = isNegative ? delayStr.substring(1) : delayStr;
            const parts = cleanStr.split(':').map(Number);
            
            let days = 0;
            let hours = 0;
            
            if (parts.length === 2) {
                [days, hours] = parts;
            } else if (parts.length === 3) {
                // 處理 H:MM:SS 格式
                const [h, m, s] = parts;
                days = Math.floor(h / 24);
                hours = h % 24 + m / 60 + s / 3600;
            }

            const totalDays = days + hours / 24;
            return isNegative ? -totalDays : totalDays;
        }

        // 根據延遲天數取得 Bootstrap Badge 類別和狀態文字
        function getDelayBadgeInfo(delayStr) {
            const totalDays = parseDelayTime(delayStr);
            if (totalDays < 0) {
                return {
                    badgeClass: "bg-success",
                    statusText: "提早",
                    textColor: "text-success"
                };
            } else if (totalDays === 0) {
                return {
                    badgeClass: "bg-info",
                    statusText: "準時",
                    textColor: "text-info"
                };
            } else if (totalDays <= 2) {
                return {
                    badgeClass: "bg-warning",
                    statusText: "輕微延遲",
                    textColor: "text-warning"
                };
            } else {
                return {
                    badgeClass: "bg-danger",
                    statusText: "嚴重延遲",
                    textColor: "text-danger"
                };
            }
        }

        // 載入資料
        function loadData() {
            updateStatus('spinner fa-spin', '從伺服器載入資料...', 'loading');
            showLoading(true);

            // 修正檔案路徑以符合實際目錄與檔名
            let file = "plan_result/LotPlanResult.json"; 

            // 調整為使用相對路徑或正確的 API 端口，此處優先嘗試從當前主機抓取
            fetch(`/${file}`)
                .then(res => {
                    if (!res.ok) {
                        // 如果相對路徑失敗，嘗試 port 8000 (FastAPI 預設)
                        return fetch(`http://127.0.0.1:8000/${file}`);
                    }
                    return res;
                })
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    return res.json();
                })
                .then(data => {
                    // 處理新的 JSON 結構
                    if (data.lot_results) {
                        allData = data.lot_results;
                        statistics = data.statistics;
                    } else {
                        allData = data;
                        statistics = null;
                    }

                    updateFilters(allData);
                    renderTable(allData);
                    renderStatistics(statistics);

                    updateStatus('check-circle', `已載入 ${allData.length} 筆資料`, 'success');
                    showLoading(false);
                })
                .catch(err => {
                    console.error("資料載入失敗", err);
                    updateStatus('exclamation-triangle', '載入失敗', 'error');
                    showLoading(false);
                    document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="text-center"><div class="status-indicator status-error"><i class="fa-solid fa-exclamation-triangle"></i> 資料載入失敗</div></td></tr>';
                });
        }

        // 渲染統計資訊
        function renderStatistics(stats) {
            const section = document.getElementById('statisticsSection');
            if (!stats) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'flex';
            
            document.getElementById('optType').textContent = stats.optimization_type || 'N/A';
            document.getElementById('batchCount').textContent = stats.batch_count || 0;
            document.getElementById('optGoal').textContent = stats.optimization_goal || 'N/A';
            
            const start = stats.calculation_start ? new Date(stats.calculation_start).toLocaleString('zh-TW') : 'N/A';
            const end = stats.calculation_end ? new Date(stats.calculation_end).toLocaleString('zh-TW') : 'N/A';
            document.getElementById('calcTimeRange').textContent = `${start} ~ ${end}`;
            document.getElementById('calcDuration').textContent = stats.calculation_duration || 'N/A';
            
            document.getElementById('earliestInput').textContent = stats.earliest_input_time ? new Date(stats.earliest_input_time).toLocaleString('zh-TW') : 'N/A';
            document.getElementById('latestOutput').textContent = stats.latest_output_time ? new Date(stats.latest_output_time).toLocaleString('zh-TW') : 'N/A';
            document.getElementById('totalDuration').textContent = stats.total_schedule_duration || 'N/A';
            
            document.getElementById('earlyCount').textContent = stats.early_count !== undefined ? stats.early_count : '-';
            document.getElementById('onTimeCount').textContent = stats.on_time_count !== undefined ? stats.on_time_count : '-';
            document.getElementById('minorDelayCount').textContent = stats.minor_delay_count !== undefined ? stats.minor_delay_count : '-';
            document.getElementById('majorDelayCount').textContent = stats.major_delay_count !== undefined ? stats.major_delay_count : '-';
        }

        // 更新過濾器選項
        function updateFilters(data) {
            // 更新批號過濾器
            const lotSelect = document.getElementById("lotFilter");
            lotSelect.innerHTML = '<option value="ALL">全部</option>';
            const uniqueLots = [...new Set(data.map(d => d.Lot))].sort();
            uniqueLots.forEach(lot => {
                const opt = document.createElement("option");
                opt.value = lot;
                opt.textContent = lot;
                lotSelect.appendChild(opt);
            });

            // 更新產品過濾器
            const productSelect = document.getElementById("productFilter");
            productSelect.innerHTML = '<option value="ALL">全部</option>';
            const uniqueProducts = [...new Set(data.map(d => d.Product))].sort();
            uniqueProducts.forEach(product => {
                const opt = document.createElement("option");
                opt.value = product;
                opt.textContent = product;
                productSelect.appendChild(opt);
            });
        }

        // 應用過濾器
        function applyFilters() {
            if (!table) return;

            const selectedLot = document.getElementById("lotFilter").value;
            const selectedProduct = document.getElementById("productFilter").value;

            // 使用 DataTables 的 column search
            table.column(0).search(selectedLot === "ALL" ? "" : selectedLot);
            table.column(1).search(selectedProduct === "ALL" ? "" : selectedProduct);

            table.draw();
        }

        // 渲染表格
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');

                // Lot
                const tdLot = document.createElement('td');
                tdLot.textContent = row.Lot;
                tr.appendChild(tdLot);

                // Product
                const tdProduct = document.createElement('td');
                tdProduct.textContent = row.Product;
                tr.appendChild(tdProduct);

                // Priority
                const tdPriority = document.createElement('td');
                tdPriority.textContent = row.Priority;
                tr.appendChild(tdPriority);

                // DueDate
                const tdDueDate = document.createElement('td');
                const dueDate = row["DueDate"] ? new Date(row["DueDate"]) : null;
                tdDueDate.textContent = (dueDate && !isNaN(dueDate.getTime())) ? dueDate.toLocaleString('zh-TW') : 'N/A';
                tr.appendChild(tdDueDate);

                // PlanFinishDate
                const tdPlanFinishDate = document.createElement('td');
                const planFinishDate = row["PlanFinishDate"] ? new Date(row["PlanFinishDate"]) : null;
                tdPlanFinishDate.textContent = (planFinishDate && !isNaN(planFinishDate.getTime())) ? planFinishDate.toLocaleString('zh-TW') : 'N/A';
                tr.appendChild(tdPlanFinishDate);

                // ActualFinishDate
                const tdActualFinishDate = document.createElement('td');
                const actualFinishDate = row["ActualFinishDate"] ? new Date(row["ActualFinishDate"]) : null;
                tdActualFinishDate.textContent = (actualFinishDate && !isNaN(actualFinishDate.getTime())) ? actualFinishDate.toLocaleString('zh-TW') : 'N/A';
                tr.appendChild(tdActualFinishDate);

                // Delay Time
                const tdDelay = document.createElement('td');
                const badgeInfo = getDelayBadgeInfo(row["delay time"]);
                tdDelay.innerHTML = `<span class="${badgeInfo.textColor} delay-text">${row["delay time"]}</span>`;
                tr.appendChild(tdDelay);

                // Status (Bootstrap Badge)
                const tdStatus = document.createElement('td');
                tdStatus.innerHTML = `<span class="badge ${badgeInfo.badgeClass}">${badgeInfo.statusText}</span>`;
                tr.appendChild(tdStatus);

                tbody.appendChild(tr);
            });

            // 初始化或重新初始化 DataTables
            if (table) {
                table.destroy();
            }
            table = $('#resultTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json"
                },
                "pageLength": 25,
                "lengthMenu": [10, 25, 50, 100],
                "responsive": true,
                "order": [[0, 'asc']], // 預設按 Lot 排序
                "columnDefs": [
                    { "orderable": true, "targets": [0, 1, 2] }, // Lot, Product, Priority 可排序
                    { "orderable": false, "targets": [3, 4, 5, 6] } // 日期和狀態不可排序
                ],
                "dom": '<"top"f>rt<"bottom"lp><"clear">', // 搜尋框在上方，分頁在下方
                "initComplete": function() {
                    // 自定義搜尋框樣式
                    $('.dataTables_filter input').addClass('form-control').css('width', '300px');
                }
            });
        }

        // 初始化應用程式
        function initializeApp() {
            // Theme initialization is handled by theme-manager.js

            // 設定檔案輸入事件監聽器
            document.getElementById('jsonFileInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    updateStatus('spinner fa-spin', '解析檔案中...', 'loading');
                    showLoading(true);

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            // 處理新的 JSON 結構
                            if (data.lot_results) {
                                allData = data.lot_results;
                                statistics = data.statistics;
                            } else {
                                allData = data;
                                statistics = null;
                            }

                            updateFilters(allData);
                            renderTable(allData);
                            renderStatistics(statistics);

                            updateStatus('check-circle', `已載入 ${allData.length} 筆資料`, 'success');
                            showLoading(false);

                            // 儲存檔案名稱到 localStorage
                            localStorage.setItem('lastLoadedFile', file.name);

                        } catch (error) {
                            updateStatus('exclamation-triangle', '解析失敗', 'error');
                            showLoading(false);
                            alert("解析 JSON 失敗: " + error.message);
                        }
                    };

                    reader.onerror = function() {
                        updateStatus('exclamation-triangle', '讀取失敗', 'error');
                        showLoading(false);
                        alert("讀取檔案失敗");
                    };

                    reader.readAsText(file);
                }
            });

            // 停用自動載入資料 - 需要手動透過檔案上傳載入
            updateStatus('info-circle', '請選擇 JSON 檔案載入資料', 'info');
        }

        // 當頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>